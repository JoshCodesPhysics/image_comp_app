version: '3'

tasks:
  install:
    desc: Setup Python venv and install dependencies
    cmds:
      - python3.10 -m venv .venv
      - .venv/bin/pip install --upgrade pip
      - .venv/bin/pip install -r requirements.txt

  postgres:start:
    desc: Start Postgres via Docker
    cmds:
      - sudo docker run --rm -d --name image_diff_db -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=image_diff -p 5432:5432 postgres:15

  postgres:stop:
    desc: Stop Postgres container
    cmds:
      - sudo docker stop image_diff_db || true

  server:
    desc: Start FastAPI server with uvicorn
    cmds:
      - .venv/bin/uvicorn app:app --reload --host 0.0.0.0 --port 8000

  startup:
    desc: Start Postgres + FastAPI (watch mode)
    deps: [postgres:start, install]
    cmds:
      - task server

  shutdown:
    desc: Stop all services (Postgres + any running processes)
    cmds:
      - sudo docker stop image_diff_db || true
      - pkill -f "uvicorn app:app" || true
      - echo "All services stopped"

  test:
    desc: Run all test functions
    deps: [install]
    cmds:
      - .venv/bin/python test_functions.py

  test:spatial:
    desc: Run spatial region difference analysis tests only
    deps: [install]
    cmds:
      - .venv/bin/python -c "from test_functions import test_spatial_difference_regions; test_spatial_difference_regions()"

  test:formats:
    desc: Run image format comparison tests only
    deps: [install]
    cmds:
      - .venv/bin/python -c "from test_functions import test_image_formats; test_image_formats()"

  test:quick:
    desc: Run quick tests (database, image reading, histograms)
    deps: [install]
    cmds:
      - .venv/bin/python -c "from test_functions import test_database_initialization, test_image_reading, test_channel_histogram; test_database_initialization(); test_image_reading(); test_channel_histogram()"

  test:url:
    desc: Run build_diff_url tests only
    deps: [install]
    cmds:
      - .venv/bin/python -c "from test_functions import test_build_diff_url; test_build_diff_url()"